{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-sm-8 mx-auto">
    <div class="card mb-3">
      <div class="card-body position-relative p-0">
        <!-- Banner Image -->
        <div style="height: 200px; overflow: hidden;">
          <img src="{{ profile_user['banner_picture'] }}" alt="Banner" style="width: 100%; height: 100%; object-fit: cover;">
        </div>

        <!-- Profile Picture (overlapping banner) -->
        <div style="position: relative; margin-top: -60px; padding: 0 20px;">
          <div style="width: 200px; height: 200px; border-radius: 50%; background-color: white; display: inline-block;">
            <img
              src="{{ profile_user['profile_picture'] }}"
              alt="Embedded Profile Picture"
              style="width: 200px; height: 200px; border-radius: 50%; border: 3px solid white; object-fit: cover;">
          </div>

          <div style="padding: 20px 0;">
            <h3 class="card-title">{{ profile_user['username'] }}</h3>
            <p>{{ profile_user['bio'] }}</p>
            {% if user['username'] == profile_user['username'] %}
              <a href="{{ url_for('profile.edit_profile') }}" class="btn btn-secondary btn-sm">Edit Profile</a>
            {% endif %}
            <button class="btn btn-secondary btn-sm" onclick="toggleAudio()">Mute/Unmute</button>
          </div>
        </div>

        <script>
          function toggleAudio() {
            const audio = document.getElementById('profile-audio');
            audio.muted = !audio.muted;
          }
        </script>
      </div>
    </div>

    <audio id="profile-audio" autoplay loop muted>
      <source src="{{ profile_user['profile_audio'] }}" type="audio/mpeg">
    </audio>

    <script>
      const audio = document.getElementById('profile-audio');
      window.addEventListener('load', () => {
        setTimeout(() => {
          audio.muted = false;
          audio.play().catch(err => console.warn('Autoplay blocked:', err));
        }, 500);
      });
    </script>

    <!-- ===== Graffiti toolbar ===== -->
    <div class="graffiti-toolbar card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center flex-wrap gap-2">
          <label class="mb-0 mr-2">
            <input id="toggle" type="checkbox"> <strong>ðŸŽ¨ Graffiti Mode</strong>
          </label>

          <button id="pen"    type="button" class="btn btn-sm btn-secondary mr-1">Pen</button>
          <button id="eraser" type="button" class="btn btn-sm btn-outline-secondary mr-3">Eraser</button>

          <label class="mb-0 mr-2">Color <input id="color" type="color" value="#000000" class="ml-1"></label>
          <label class="mb-0 mr-3">Size <input id="size" type="number" min="1" max="24" value="4" class="ml-1" style="width:70px"></label>

          <button id="push"  type="button" class="btn btn-sm btn-success mr-2">â¬† Push to Profile</button>
          <button id="clear" type="button" class="btn btn-sm btn-outline-danger">ðŸ§¹ Clear</button>
        </div>
      </div>
    </div>

    <!-- ===== FULL-PAGE TRANSPARENT CANVAS ===== -->
    <canvas id="c"></canvas>

    <!-- Provide profile ID for JS -->
    <script>
      window.G = window.G || {};
      window.G.profileId = "{{ profile_user['username'] }}";
    </script>

    <!-- Graffiti CSS + JS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/graffiti.css') }}">
    <script defer src="{{ url_for('static', filename='js/graffiti.js') }}"></script>

    <h4>{{ profile_user['username'] }}'s Posts</h4>
    {% if posts %}
      {% for post in posts %}
        <div class="card mb-2">
          <div class="card-body">
            <p>{{ post['text'] }}</p>
            <small class="text-muted">{{ post['formatted_time'] }}</small>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No posts yet.</p>
    {% endif %}
  </div>
</div>

<!-- Toggles canvas pointer events -->
<script>
  const toggle = document.getElementById("toggle");
  const c = document.getElementById("c");

  toggle.addEventListener("change", () => {
    c.style.pointerEvents = toggle.checked ? "auto" : "none";
  });
</script>

{% endblock %}
