{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-sm-8 mx-auto">
    <div class="card mb-3">
      <div class="card-body position-relative p-0">
        <!-- Banner Image -->
        <div style="height: 200px; overflow: hidden;">
          <img id="banner-image" src="{{ profile_user['banner_picture'] }}" alt="Banner" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        
        <!-- Profile Picture (overlapping banner) -->
        <div style="position: relative; margin-top: -60px; padding: 0 20px;">
          <div style="width: 200px; height: 200px; border-radius: 50%; background-color: white; display: inline-block;">
            <img
              id="profile-image" 
              src="{{ profile_user['profile_picture'] }}" 
              alt="Embedded Profile Picture"
              style="width: 200px; height: 200px; border-radius: 50%; border: 3px solid white; object-fit: cover;">
          </div>
          
          <!-- Profile Info -->
          <div style="padding: 20px 0;">
            <h3 class="card-title" name="username">{{ profile_user['username'] }}</h3>
            <!-- Friends count -->
            <p id="friends-count" style="cursor: pointer; color: #007bff;"></p>
            
            <p id="bio" name="bio">{{ profile_user['bio'] }}</p>
            {% if user['username'] == profile_user['username'] %}
              <a href="{{ url_for('profile.edit_profile') }}" class="btn btn-secondary btn-sm">Edit Profile</a>
            {% endif %}
            <button name="audio-toggle" class="btn btn-secondary btn-sm" onclick="toggleAudio()">Mute/Unmute</button>
          </div>
        </div>

        <script>
          function toggleAudio() {
            const audio = document.getElementById('profile-audio');
            audio.muted = !audio.muted;
          }

          document.addEventListener("DOMContentLoaded", () => {
            const friends = {{ profile_user['friends']|tojson }};
            const friendsCountEl = document.getElementById("friends-count");
            const count = friends.length;
            friendsCountEl.textContent = `${count} friend${count !== 1 ? 's' : ''}`;

            friendsCountEl.addEventListener("click", () => {
              console.log("Friends pressed");
              showFriendsPopup(friends);
            });
          });

          function showFriendsPopup(friends) {
            const modal = document.getElementById("friends-modal");
            const listContainer = document.getElementById("friends-list");
            listContainer.innerHTML = ""; // Clear previous contents

            if (friends.length === 0) {
              listContainer.innerHTML = "<p>No friends yet.</p>";
            } else {
              friends.forEach(f => {
                const username = f.username || f;
                const link = document.createElement("a");
                link.textContent = username;
                link.href = `/profile/${username}`;
                link.style.display = "block";
                link.style.color = "#007bff";
                link.style.textDecoration = "none";
                link.style.padding = "5px 0";
                link.addEventListener("mouseover", () => link.style.textDecoration = "underline");
                link.addEventListener("mouseout", () => link.style.textDecoration = "none");
                listContainer.appendChild(link);
              });
            }

            modal.style.display = "flex";
          }

          function closeFriendsPopup() {
            document.getElementById("friends-modal").style.display = "none";
          }
        </script>

        <!-- Popup Modal -->
        <div id="friends-modal" 
             style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                    background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
          <div style="background:white; padding:20px; border-radius:10px; width:300px; max-height:400px; overflow-y:auto;">
            <h5>Friends</h5>
            <div id="friends-list" style="margin-top:10px;"></div>
            <button class="btn btn-secondary btn-sm mt-2" onclick="closeFriendsPopup()">Close</button>
          </div>
        </div>

      </div>
    </div>

    <audio id="profile-audio" autoplay loop muted>
      <source src="{{ profile_user['profile_audio'] }}" type="audio/mpeg">
    </audio>

    <script>
      const audio = document.getElementById('profile-audio');
      window.addEventListener('load', () => {
        setTimeout(() => {
          audio.muted = false;
          audio.play().catch(err => console.warn('Autoplay blocked:', err));
        }, 500);
      });
    </script>

    <!-- ===== Graffiti toolbar & canvas ===== -->
    <div class="graffiti-toolbar card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center flex-wrap gap-2">
          <label class="mb-0 mr-2">
            <input id="toggle" type="checkbox"> <strong>ðŸŽ¨ Graffiti Mode</strong>
          </label>

          <button id="pen"    type="button" class="btn btn-sm btn-secondary mr-1">Pen</button>
          <button id="eraser" type="button" class="btn btn-sm btn-outline-secondary mr-3">Eraser</button>

          <label class="mb-0 mr-2">Color <input id="color" type="color" value="#000000" class="ml-1"></label>
          <label class="mb-0 mr-3">Size <input id="size" type="number" min="1" max="24" value="4" class="ml-1" style="width:70px"></label>

          <button id="push"  type="button" class="btn btn-sm btn-success mr-2">â¬† Push to Profile</button>
          <button id="clear" type="button" class="btn btn-sm btn-outline-danger">ðŸ§¹ Clear</button>
        </div>
      </div>
    </div>

    <div class="graffiti-canvas-wrap mb-4">
      <canvas id="c"></canvas>
    </div>
    <!-- ===== /Graffiti ===== -->

    <!-- expose profile id for JS -->
    <script>
      window.G = window.G || {};
      window.G.profileId = "{{ profile_user['username'] }}";
    </script>
    
    

    <!-- load CSS/JS for graffiti -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/graffiti.css') }}">
    <script defer src="{{ url_for('static', filename='js/graffiti.js') }}"></script>

    <h4>{{ profile_user['username'] }}'s Posts</h4>
    {% if posts %}
      {% for post in posts %}
        <div class="card mb-2">
          <div class="card-body">
            <p>{{ post['text'] }}</p>
            <small class="text-muted">{{ post['formatted_time'] }}</small>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No posts yet.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
